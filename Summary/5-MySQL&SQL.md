#### MySQL 数据库和 SQL



#### MySQL及InnoDB引擎

​       MySQL 数据库目前已成为了互联网时代，最为流行的企业级数据库之一。mySQL从 5.7起，在性能、扩展性、高可用等方面做了大量的改进型，在多种应用场景下发挥良好。与其他DB不同的是，mySQL插件式的存储引擎，将查询处理和其他的任务系统及数据存储分离开，这种架构设计使得具体应用时，可以根据实际需求场景，选择合适的存储引擎。

​      InnoDB是MySQL5.1以后默认的事务引擎，支持多核CPU，性能良好, 支持高并发，使用B+Tree来组织。 实现了SQL92规定的四个标准的隔离级别，默认级别为可重复读（REPEATABLE READ),  其事务是由MVCC(多版本并发控制)實現的。并通过间隙锁（next-key locking)策略防止幻读的出现。间隙锁使得InnoDB不仅仅锁定查询涉及的行，还会对索引中的间隙进行锁定，以防止幻影行的插入。

​      由于InnoDb表是基于聚簇索引建立的，对主键查询有很高的性能，但它的耳机索引（secondary index, 非主键索引）中必须要包含主键列，所以如果主键列很大的化，其他的所有索引都会很大。因此，如果表上的索引较多的话，主键应当尽可能地小。

InnoDB做了大量的功能优化，包括：

1. 从磁盘读取数据，采用可预测性的预读，能够自动在内存中创建hash索引以加速读操作的自适应哈希索引(adptive hash index),以及能够加速插入操作的插入缓冲区（insert buffer),。 
2. InnoDB通过一些机制和工具支持真正的热备份。
3. 支持崩溃恢复。
4. InnoDB在可测试性、可扩展性、性能、各种新特征和读写



#### 存储引擎的选择

​     除InnoDB外，其他,mySQL常用的存储有myISAM, TokuDB等，分析其特征如下:



|              | MyISAM                    | InnoDB                           | TokuDB                                                   |
| ------------ | ------------------------- | -------------------------------- | -------------------------------------------------------- |
| 索引         | 支持全文索引，支持GIS搜索 | 聚集索引                         | 支持现有索引类型，可在线添加索引，不影响读写操作高压缩比 |
| 索引结构     |                           | B+Tree                           | 分形树(Fractal tree)                                     |
| 锁的粒度     | 表级锁                    | 锁粒度是行锁                     |                                                          |
| 事务特性     | 不支持事务                | 支持ACID事务，默认为可重复读级别 | 支持完整的ACID特性和事务机制                             |
| 崩溃恢复     | 发生损坏概率大，恢复慢    | 发生损坏概率小，恢复快           |                                                          |
| 备份         |                           | 支持在线热备份                   |                                                          |
| 写入读取性能 |                           | 性能较为均衡，有预读处理         | 高写入性能，不适用于大量读取的场景                       |
| 其他         |                           |                                  | 数据高压缩比，尤其适用于压缩和归档(1:12)                 |
| 应用场景     | 日志，及GIS应用           | 一般场景都建议使用InnoDB         | 日志、归档库(图书馆，档案馆应用)                         |

#### SQL的设计心得：

1. 在大规模互联网应用中，不建议使用多表关联，建议的做法是单表查询然后在内存中聚合和抽取。

2.  主键栏位不宜太长，并且建议用 整型，而不是字符串做主键，能加快索引查找的速度。

3.  使用不必要的大数据类型，在多维度、多系统、多副本的情况下，将造成极大的浪费。所以在这样的场景下，要设计数据类型时，做“精打细算”，及使用合适的尽量小的类型。

4. 图片、文件等，不需要存入DB，用路径+文件服务器即可

5. 加上 create_time和update_time时间戳是一个良好实践，用来记录过程，做追踪和审计用。

   

#### SQL及性能优化

1.  一定要参考监控与度量指标，再进行改进。
2. 80/20原则： 先优化性能瓶颈问题。
3. 写入时，使用preparedStatement减少SQL解析， 
4. 优化模糊查询，少用Nolt, not in 等范围使用。 
5. 若有复杂查询，改用专业的全文检索工具。



